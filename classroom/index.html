
<!DOCTYPE html>
<html>
  <head>
    <title>Tempo Classroom</title>
    <meta name="viewport" content="width=device-width">
    <mhtml type="primaryColor" color="#001E8D"></mhtml>
    <mhtml type="accentColor" color="#FFD900"></mhtml>
    <link rel="icon" type="image/png" href="../ic_launcher.png">
    <script src="https://www.gstatic.com/firebasejs/4.3.1/firebase.js"></script>
    <script>
      var currentUser = null;
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyCkr17eHQRyOX4tlE-qluYt52AhXM7Gg0I",
        authDomain: "fir-musictools.firebaseapp.com",
        databaseURL: "https://fir-musictools.firebaseio.com",
        projectId: "firebase-musictools",
        storageBucket: "firebase-musictools.appspot.com",
        messagingSenderId: "966591221600"
      };
      firebase.initializeApp(config);
      var database = firebase.database();
    </script>
    <link rel="stylesheet" href="../utilities/loader.css">
  </head>
  <body>
    <toolbar title="Tempo Classroom"></toolbar>
    <content>
      <include id="container" includeID="loadingFragment"></include>
    </content>
    <fragment id="initialFragment">
      <div style="text-align:center;">
        <h1>Tempo Classroom is under construction!</h1>
        <hr width="100%" />
      </div>
      Tempo Classroom helps you manage your music students by allowing them to submit playing tests and practice reports. For a limited time, you can sign up for a free classroom account.
      <mbutton accent onClick="setIncludeID('container','signInFragment')">Register Your Class</mbutton>
    </fragment>
    <fragment id="signInFragment">
      To begin with, please sign in to or create your personal account in a new tab:<br />
      <a href="../widget?r=https://tempo.matthewwhitaker.me/classroom#" target="_blank">Click here to sign in or create account in a new tab.</a>
    </fragment>
    <fragment id="createClassFragment">
      <h3>Enter your class details:</h3>
      <form>
        <EditText hint="Class Name" id="classname" required></EditText><br />
        <EditText hint="Class Description" type="multiline" id="classdescription" required></EditText><br />
        <EditText hint="School Name" id="classschoolname" required></EditText><br />
      </form>
      <mbutton onClick="newClass()">Create Class</mbutton>
    </fragment>
    <fragment id="classroomFragment">
      Classroom is currently under construction...
    </fragment>
    <fragment id="loadingFragment">
      <div style="text-align:center;"><div class="pulse"></div> Loading...</div>
    </fragment>
    <script src="https://matthewwhitaker.me/api/mhtml.js"></script>
    <script>
      function onAuthInit() {
          if(photoURL == null || photoURL == undefined) {
            photoURL = "https://tempo.matthewwhitaker.me/null.svg";
          }
          if(displayName == undefined || displayName == null) {
            displayName = "Signed Out";
          }
      }
      function onMHTML() {
        firebase.auth().onAuthStateChanged(function(user) {
          currentUser = user;
          if (user) {
            database.ref("/users/"+user.uid+"/classes").once('value').then(function(snapshot) {
              if(snapshot.val()) {
                //User has classes
                setIncludeId("container", "classroomFragment");
              } else {
                //User needs to create a class.
                setIncludeID("container", "createClassFragment");
              }
            });
          } else {
            setIncludeID("container", "initialFragment");
          }
        });
      }
      function newClass() {
        var className = document.getElementById("classname").value;
        var classDescription = document.getElementById("classdescription").value;
        var classSchoolName = document.getElementById("classschoolname").value;
        var data = {
          className: className,
          classDescription: classDescription,
          classSchoolName: classSchoolName,
          teacherID:currentUser.uid,
          teacher:currentUser.displayName
        };
        var newClassKey = database.ref("/classes").push().key;
        database.ref("/classes/"+newClassKey).set(data);
        var updates = {};
        updates['/'+newClassKey] = "true";
        database.ref("/users/"+currentUser.uid+"/classes").update(updates);
        window.location.reload();
      }
    </script>
    <script src="../account.js"></script>
  </body>
</html>
